box:
  id: alpine
  cmd: /bin/sh

build:
  box:
    id: golang:alpine
    cmd: /bin/sh

  steps:
    - script:
        name: install dependencies
        code: |
          apk --update add perl git curl
          git clone --depth 1 https://github.com/bagder/curl.git

    - script:
        name: build ca bundle
        code: |
          mkdir -p "$WERCKER_OUTPUT_DIR"/etc/ssl/certs/
          ./curl/lib/mk-ca-bundle.pl "$WERCKER_OUTPUT_DIR"/etc/ssl/certs/ca-certificates.crt

    - script:
        name: build oauth2_proxy
        code: |
          go get github.com/bitly/oauth2_proxy
          cd "$GOPATH"/src/github.com/bitly/oauth2_proxy
          CGO_ENABLED=0 go build --ldflags "-s -w -extldflags '-static'" -o "$WERCKER_OUTPUT_DIR"/oauth2_proxy .

push:
  steps:
    - internal/docker-scratch-push:
        username: cehoffman+wercker
        password: $QUAY_ROBOT_PASSWORD
        ports: "4180/tcp"
        entrypoint: /oauth2_proxy
        tag: $WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT
        repository: quay.io/cehoffman/oauth2_proxy
        registry: https://quay.io/v2
