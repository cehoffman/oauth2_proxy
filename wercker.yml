box:
  id: alpine
  cmd: /bin/sh

build:
  box:
    id: golang:1.8-alpine
    cmd: /bin/sh

  steps:
    - script:
        name: install dependencies
        code: |
          apk --update add perl git curl bash
          curl -s https://raw.githubusercontent.com/pote/gpm/v1.4.0/bin/gpm > /bin/gpm
          chmod +x /bin/gpm

    - script:
        name: build ca bundle
        code: |
          mkdir -p "$WERCKER_OUTPUT_DIR"/etc/ssl/certs/
          curl -LO https://raw.githubusercontent.com/curl/curl/master/lib/mk-ca-bundle.pl
          perl ./mk-ca-bundle.pl "$WERCKER_OUTPUT_DIR"/etc/ssl/certs/ca-certificates.crt

    - script:
        name: fetch oauth2_proxy
        code: |
          mkdir -p "$GOPATH"/src/github.com/bitly/oauth2_proxy
          git clone --branch v2.2 https://github.com/bitly/oauth2_proxy "$GOPATH"/src/github.com/bitly/oauth2_proxy
          cd "$GOPATH"/src/github.com/bitly/oauth2_proxy
          gpm install

    - script:
        name: go vet
        code: |
          cd "$GOPATH"/src/github.com/bitly/oauth2_proxy
          go vet ./...

    - script:
        name: go test
        code: |
          cd "$GOPATH"/src/github.com/bitly/oauth2_proxy
          go test --timeout=60s ./...

    - script:
        name: go build
        code: |
          cd "$GOPATH"/src/github.com/bitly/oauth2_proxy
          CGO_ENABLED=0 go build --ldflags "-s -w -extldflags '-static'" -o "$WERCKER_OUTPUT_DIR"/oauth2_proxy .

push:
  steps:
    - internal/docker-scratch-push:
        username: cehoffman+wercker
        password: $QUAY_ROBOT_PASSWORD
        ports: "4180/tcp"
        entrypoint: /oauth2_proxy
        tag: $WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT
        repository: quay.io/cehoffman/oauth2_proxy
        registry: https://quay.io/v2
